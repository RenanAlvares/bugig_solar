{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='style/menu_benef.css') }}">

<main id="benef-main">
  <div class="dashboard" id="dashboard-container">

    <!-- üîÜ Cabe√ßalho Energizado -->
    <div id="energy-header">
      <h1>Painel do Benefici√°rio</h1>
      <p>Gerencie sua conta de energia e aproveite todos os benef√≠cios dispon√≠veis.</p>
    </div>

    {% if del_doacao %}
    <div class="queue-status-card">
    <div class="dashboard-cards">
        <h3>Voc√™ tem uma solicita√ß√£o e ainda n√£o foi contemplado.</h3>
        <p>Para sair da fila, clique aqui</p>
        <a href="{{ url_for('auth.del_queue', user_id=user_id, queue_id=del_queue) }}" class="btn btn-danger btn-default btn-sm">Sair da fila</a>
    </div>
    </div>
    {% endif %}

    <!-- CARD DA FILA - DESTAQUE NO TOPO (FORA DO GRID) -->
    <div class="queue-status-card card-payment">
      {% if posicao_fila %}
        <div class="queue-content">
          <div class="queue-icon-section">
            <div class="queue-main-icon">
              <i class="fa-solid fa-users-line"></i>
            </div>
            <div class="queue-text">
              <h3>Voc√™ est√° na fila!</h3>
              <p>Aguardando para receber os pr√≥ximos cr√©ditos de energia. Fique atento √† sua posi√ß√£o.</p>
            </div>
          </div>
          <div class="queue-position">
            <div class="queue-position-label">Posi√ß√£o Atual</div>
            <div class="queue-position-number">{{ posicao_fila }}</div>
          </div>
        </div>
      {% else %}
        <div class="queue-empty-state">
          <div class="queue-main-icon" style="margin: 0 auto 1.5rem;">
            <i class="fa-solid fa-users-line"></i>
          </div>
          <h3>Voc√™ n√£o est√° na fila no momento</h3>
          <p>Entre na fila agora para garantir seu lugar e receber os pr√≥ximos cr√©ditos de energia dispon√≠veis.</p>
        </div>         

        <style>
          .btn-default{
            margin-top: 10px;
            padding: 100%;
          }
        </style>
      {% endif %}
    </div>

    {% if session.get('ultimo_pagamento_id') %}
    <!-- CARD DE ALERTA DE PAGAMENTO (TAMB√âM FORA DO GRID) -->
    <div class="queue-status-card">
      <div class="payment-alert-overlay" id="paymentAlertOverlay">
        <div class="payment-alert-container" id="paymentAlert">
          <div class="payment-alert-icon">
            <i class="fa-solid fa-circle-check"></i>
          </div>
          <div class="payment-alert-content">
            <h3>Pagamento Realizado com Sucesso!</h3>
            <p>Seu comprovante est√° pronto para download</p>
            <a href="{{ url_for('auth.download_payment_csv', user_id=user_id, pagamento_id=session.pop('ultimo_pagamento_id')) }}" 
               class="btn-default" 
               id="downloadLink">
              <i class="fa-solid fa-download" id="download-payment"></i>
              Baixar Comprovante
            </a>
          </div>

          <script>
            //js fechar card.
            document.addEventListener('DOMContentLoaded', function() {
              const overlay = document.getElementById('paymentAlertOverlay');
              const cardElement = overlay ? overlay.parentElement : null; 
              const closeBtn = document.getElementById('closeAlertBtn');
              const downloadLink = document.getElementById('downloadLink');

              function hideCard() {
                  if (cardElement) {
                      cardElement.classList.add('is-hidden'); 
                  }
              }

              if (closeBtn) {
                  closeBtn.addEventListener('click', hideCard);
              }

              if (downloadLink) {
                  downloadLink.addEventListener('click', hideCard);
              }
            });
          </script>

        </div>
        <button class="payment-alert-close" id="closeAlertBtn" style="display: none;">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
      const downloadLink = document.getElementById('downloadLink');
      const overlay = document.getElementById('paymentAlertOverlay');
      const alertContainer = document.getElementById('paymentAlert');
      const closeBtn = document.getElementById('closeAlertBtn');
      
      if (downloadLink && overlay) {
        // Quando clicar no link de download
        downloadLink.addEventListener('click', function(e) {
          // Aguarda o download iniciar
          setTimeout(function() {
            // Mostra o bot√£o de fechar
            closeBtn.style.display = 'flex';
            
            // Adiciona anima√ß√£o de sa√≠da ap√≥s 1 segundo
            setTimeout(function() {
              alertContainer.style.animation = 'slideOutUp 0.5s ease-out forwards';
              
              setTimeout(function() {
                overlay.style.opacity = '0';
                setTimeout(function() {
                  overlay.remove();
                }, 300);
              }, 400);
            }, 1000);
          }, 500);
        });
        
        // Bot√£o de fechar manual (caso o usu√°rio queira fechar depois)
        closeBtn.addEventListener('click', function() {
          alertContainer.style.animation = 'slideOutUp 0.5s ease-out forwards';
          setTimeout(function() {
            overlay.style.opacity = '0';
            setTimeout(function() {
              overlay.remove();
            }, 300);
          }, 400);
        });
      }
    });
    </script>
    {% endif %}

    <!-- üí≥ Cards Principais (GRID COME√áA AQUI) -->
    <div class="dashboard-cards">
      
      <!-- CARD: ENTRAR NA FILA (se j√° estiver na fila) -->
      {% if posicao_fila %}
      <a href="{{ url_for('auth.get_in_queue', user_id=user_id) }}" class="card">
        <div class="card-icon"><i class="fa-solid fa-users-line"></i></div>
        <h3>Gerenciar Fila</h3>
        <p>Atualize sua posi√ß√£o ou saia da fila de cr√©ditos.</p>
      </a>

      {% else %}

      <div class="card">
        <div class="card-icon"><i class="fa-solid fa-users-line"></i></div>
            <h3>Entre na Fila</h3>
            <p>Clique e garanta o quanto antes seus pr√≥ximos cr√©ditos de energia.</p>
            <a href="{{ url_for('auth.get_in_queue', user_id=user_id) }}" class="btn-default">
              <i class="fa-solid fa-plus-circle" style="margin-right: 8px;"></i>Entrar na Fila
            </a>
      </div>

      {% endif %}

      <!-- CARD: RELAT√ìRIOS -->
      <a href="{{ url_for('auth.report_benef', user_id=user_id) }}" class="card">
        <div class="card-icon"><i class="fa-solid fa-chart-pie"></i></div>
        <h3>Meus Relat√≥rios</h3>
        <p>Acompanhe seu hist√≥rico de cr√©ditos e a economia gerada.</p>
      </a>

      <!-- CARD: EDITAR PERFIL -->
      <a href="{{ url_for('auth.edit_user', user_id=user_id) }}" class="card">
        <div class="card-icon"><i class="fa-solid fa-user-pen"></i></div>
        <h3>Editar Perfil</h3>
        <p>Mantenha seus dados cadastrais sempre atualizados.</p>
      </a>

      <!-- CARD: PAGAMENTO -->
      <a href="#" class="card" id="card-pagamento">
        <div class="card-icon">
          <i class="fa-solid fa-credit-card"></i>
          {% if pagamento_pendente %}
            <span class="badge">!</span>
          {% endif %}
        </div>
        <h3>Pagamento</h3>
        <p>Realize o pagamento da transfer√™ncia para receber os cr√©ditos solicitados.</p>
      </a>
      
    </div>
  </div>
<!-- ======= Modal de Pagamento ======= -->
<div id="modal-pagamento" class="modal">
  <div class="modal-content">
    <span class="close" id="fechar-modal">&times;</span>
    <h2>üí≥ Pagamento</h2>

    {% if pagamento_pendente %}
      <p><strong>Valor:</strong> R$ {{ pagamento_pendente.valor }}</p>
      <p><strong>Vencimento:</strong> {{ pagamento_pendente.data_vencimento.strftime('%d/%m/%Y') }}</p>
    {% else %}
      <p>N√£o h√° pagamentos pendentes no momento.</p>
    {% endif %}

{% if pagamento_pendente %}
<form method="POST" action="{{ url_for('auth.payment', user_id=user_id) }}">
  <label for="tipo_pagamento">Tipo de pagamento:</label>
  <select class="form-select" name="tipo_pagamento" id="tipo_pagamento" required>
    {% for tp in tipo_pagamento %}
      <option class="form-select" value="{{ tp.id }}">{{ tp.nome_tipo}}</option>
    {% endfor %}
  </select>

  <div class="password-field-container">
    {{ form_payment.senha.label}}
    <div class="password-input-wrapper">
      {{ form_payment.senha(class="password-input", type="password") }}
      <button type="button" class="toggle-password" id="togglePassword">
        <i class="fa-solid fa-eye-slash" id="eyeIcon"></i>
      </button>
    </div>
  </div>
  
  {{ form_payment.pagar(class="btn-default") }}
  {{ form_payment.hidden_tag() }}
</form>
{% endif %}

<script>
// Toggle de mostrar/ocultar senha
document.addEventListener('DOMContentLoaded', function() {
  const togglePassword = document.getElementById('togglePassword');
  const senhaInput = document.querySelector('input[name="senha"]');
  const eyeIcon = document.getElementById('eyeIcon');
  
  if (togglePassword && senhaInput) {
    togglePassword.addEventListener('click', function(e) {
      e.preventDefault(); // Previne qualquer comportamento padr√£o
      
      // Alterna entre password e text
      const tipoAtual = senhaInput.getAttribute('type');
      
      if (tipoAtual === 'password') {
        // MOSTRA a senha
        senhaInput.setAttribute('type', 'text');
        eyeIcon.classList.remove('fa-eye-slash');
        eyeIcon.classList.add('fa-eye');
      } else {
        // OCULTA a senha
        senhaInput.setAttribute('type', 'password');
        eyeIcon.classList.remove('fa-eye');
        eyeIcon.classList.add('fa-eye-slash');
      }
    });
  }
});
</script>
  </div>
</div>

  <!-- Scripts -->
  <script src="{{ url_for('static', filename='js/menu_benef.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</main>
{% endblock %}